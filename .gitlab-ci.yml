stages:
  - lint
  - test
  - build
  - deploy

variables:
  GOPROXY: "https://proxy.golang.org,direct"
  CGO_ENABLED: "0"

# Cache Go modules across pipelines
cache:
  key: go-mod-${CI_COMMIT_REF_SLUG}
  paths:
    - .go-cache/

before_script:
  - export GOPATH="${CI_PROJECT_DIR}/.go-cache"
  - export GOCACHE="${CI_PROJECT_DIR}/.go-cache/build"
  - mkdir -p "$GOPATH" "$GOCACHE"

# ------------------------------------------------------------------------------
# LINT
# ------------------------------------------------------------------------------
lint:
  stage: lint
  tags: [arm64, cubeos]
  script:
    - go version
    - go mod download
    - go vet ./...
    - test -z "$(gofmt -l .)" || (echo "Code not formatted" && exit 1)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ------------------------------------------------------------------------------
# TEST
# ------------------------------------------------------------------------------
test:
  stage: test
  tags: [arm64, cubeos]
  script:
    - go mod download
    - go test -v -race -coverprofile=coverage.out ./... || true
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ------------------------------------------------------------------------------
# BUILD
# ------------------------------------------------------------------------------
build:
  stage: build
  tags: [arm64, cubeos]
  script:
    - go mod download
    - go build -ldflags="-s -w -X main.Version=${CI_COMMIT_SHORT_SHA}" -o cubeos-api ./cmd/cubeos-api/
    - ls -lh cubeos-api
  artifacts:
    paths:
      - cubeos-api
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ------------------------------------------------------------------------------
# DEPLOY
# ------------------------------------------------------------------------------
deploy:
  stage: deploy
  tags: [arm64, cubeos, deploy]
  script:
    - echo "üöÄ Deploying CubeOS API..."
    - cp /cubeos/api/cubeos-api /cubeos/api/cubeos-api.bak 2>/dev/null || true
    - cp cubeos-api /cubeos/api/cubeos-api
    - chmod +x /cubeos/api/cubeos-api
    - cd /cubeos/api && docker build -t cubeos-api:latest .
    - docker compose -f /cubeos/docker-compose.yml up -d --force-recreate cubeos-api
    - |
      echo "‚è≥ Waiting for API to be healthy..."
      for i in $(seq 1 30); do
        if curl -sf http://localhost:9009/health > /dev/null 2>&1; then
          echo "‚úÖ Health check passed!"
          exit 0
        fi
        echo "  Attempt $i/30..."
        sleep 2
      done
      echo "‚ùå Health check failed! Rolling back..."
      cp /cubeos/api/cubeos-api.bak /cubeos/api/cubeos-api
      docker compose -f /cubeos/docker-compose.yml up -d --force-recreate cubeos-api
      exit 1
  environment:
    name: production
    url: http://nllei01mule01:9009
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
