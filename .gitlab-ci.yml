# =============================================================================
# CubeOS API Pipeline - Build, Package, Deploy
# =============================================================================
stages:
  - lint
  - test
  - build
  - package
  - deploy

variables:
  GOPROXY: "https://proxy.golang.org,direct"
  GHCR_IMAGE: "ghcr.io/cubeos-app/api"
  BUILDER_IMAGE: "ghcr.io/cubeos-app/api-builder:latest"

# -----------------------------------------------------------------------------
# LINT - Uses builder image with pre-cached deps
# -----------------------------------------------------------------------------
lint:
  stage: lint
  tags: [docker]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r . /app/
    - cd /app
    - go vet ./...
    - test -z "$(gofmt -l . | grep -v vendor)" || (echo "Code not formatted" && gofmt -l . && exit 1)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# TEST - Uses builder image with pre-cached deps
# -----------------------------------------------------------------------------
test:
  stage: test
  tags: [docker]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r . /app/
    - cd /app
    - go test -v -coverprofile=coverage.out ./... || true
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# BUILD - Uses builder image with pre-cached deps
# -----------------------------------------------------------------------------
build:
  stage: build
  tags: [docker]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r . /app/
    - cd /app
    - CGO_ENABLED=1 go build -ldflags="-s -w -X main.Version=${CI_COMMIT_SHORT_SHA}" -o cubeos-api ./cmd/cubeos-api/
    - cp cubeos-api ${CI_PROJECT_DIR}/
  artifacts:
    paths:
      - cubeos-api
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# PACKAGE - Build Docker image and push to ghcr.io
# -----------------------------------------------------------------------------
package:
  stage: package
  tags: [docker]
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
  script:
    - docker build -t ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} -t ${GHCR_IMAGE}:latest .
    - docker push ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker push ${GHCR_IMAGE}:latest
    - echo "‚úÖ Pushed ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# DEPLOY - Pull image on Pi and restart
# -----------------------------------------------------------------------------
deploy:
  stage: deploy
  tags: [arm64, cubeos, deploy]
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
  script:
    - echo "üöÄ Deploying CubeOS API..."
    - docker pull ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker tag ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} cubeos-api:latest
    - docker compose -f /cubeos/docker-compose.yml up -d --force-recreate cubeos-api
    - |
      echo "‚è≥ Waiting for API to be healthy..."
      for i in $(seq 1 30); do
        if curl -sf http://localhost:9009/health > /dev/null 2>&1; then
          echo "‚úÖ Health check passed!"
          exit 0
        fi
        echo "  Attempt $i/30..."
        sleep 2
      done
      echo "‚ùå Health check failed!"
      exit 1
  environment:
    name: production
    url: http://nllei01mule01:9009
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
