# =============================================================================
# CubeOS API Pipeline - Build, Package, Deploy
# =============================================================================
stages:
  - lint
  - test
  - build
  - package
  - deploy

variables:
  GOPROXY: "https://proxy.golang.org,direct"
  GHCR_IMAGE: "ghcr.io/cubeos-app/api"
  BUILDER_IMAGE: "ghcr.io/cubeos-app/api-builder:latest"

# -----------------------------------------------------------------------------
# LINT
# -----------------------------------------------------------------------------
lint:
  stage: lint
  tags: [multiarch]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r . /app/
    - cd /app
    - go vet ./...
    - test -z "$(gofmt -l . | grep -v vendor)" || (echo "Code not formatted" && gofmt -l . && exit 1)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# TEST
# -----------------------------------------------------------------------------
test:
  stage: test
  tags: [multiarch]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r . /app/
    - cd /app
    - go clean -modcache
    - go mod download
    - go test -v -coverprofile=coverage.out ./...
    - cp coverage.out ${CI_PROJECT_DIR}/ || true
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# BUILD - Generate Swagger docs and compile binaries
# -----------------------------------------------------------------------------
build:
  stage: build
  tags: [multiarch]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r . /app/
    - cd /app
    - go clean -modcache
    - go mod download
    - go install github.com/swaggo/swag/cmd/swag@latest
    - export PATH=$PATH:$(go env GOPATH)/bin
    - |
      echo "ðŸ“ Generating Swagger documentation..."
      swag init \
        --generalInfo cmd/cubeos-api/main.go \
        --dir ./ \
        --output docs \
        --parseDependency \
        --parseInternal
    - ls -la docs/
    - GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w -X main.Version=${CI_COMMIT_SHORT_SHA}" -o cubeos-api-arm64 ./cmd/cubeos-api/
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w -X main.Version=${CI_COMMIT_SHORT_SHA}" -o cubeos-api-amd64 ./cmd/cubeos-api/
    - cp cubeos-api-arm64 cubeos-api-amd64 ${CI_PROJECT_DIR}/
    - cp -r docs ${CI_PROJECT_DIR}/
    - ls -lh ${CI_PROJECT_DIR}/cubeos-api-*
    - echo "âœ… Swagger docs generated and binaries built"
  artifacts:
    paths:
      - cubeos-api-arm64
      - cubeos-api-amd64
      - docs/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# PACKAGE - Build multi-arch Docker image and push to ghcr.io
# -----------------------------------------------------------------------------
package:
  stage: package
  tags: [multiarch]
  image: docker:24
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
    - docker buildx create --name mybuilder --driver docker-container --use
    - docker buildx inspect --bootstrap
  script:
    - |
      docker buildx build --no-cache \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -t ${GHCR_IMAGE}:latest \
        .
    - echo "âœ… Pushed multi-arch ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  after_script:
    - docker buildx rm mybuilder || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# DEPLOY - Deploy as Swarm stack on Pi with FORCED image update
# -----------------------------------------------------------------------------
deploy:
  stage: deploy
  tags: [arm64, cubeos, deploy]
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
  script:
    - echo "ðŸš€ Deploying CubeOS API as Swarm stack..."
    # Pull the specific commit image
    - docker pull ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker tag ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} ${GHCR_IMAGE}:latest
    # Check if stack exists
    - |
      if docker stack ls | grep -q cubeos-api; then
        echo "ðŸ“¦ Stack exists - forcing service update with new image..."
        docker service update \
          --force \
          --image ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} \
          --update-parallelism 1 \
          --update-delay 10s \
          --update-order stop-first \
          cubeos-api_cubeos-api
      else
        echo "ðŸ“¦ Stack doesn't exist - deploying fresh..."
        cd /cubeos/coreapps/cubeos-api/appconfig
        docker stack deploy \
          --compose-file docker-compose.yml \
          --resolve-image never \
          cubeos-api
        sleep 10
        # Force update to ensure correct image
        docker service update \
          --force \
          --image ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} \
          --update-order stop-first \
          cubeos-api_cubeos-api
      fi
    # Wait for service to be healthy
    - |
      echo "â³ Waiting for API to be healthy..."
      for i in $(seq 1 45); do
        if curl -sf http://127.0.0.1:6010/health > /dev/null 2>&1; then
          echo "âœ… Health check passed!"
          echo "ðŸ“š Swagger UI: http://cubeos.cube:6010/api/v1/docs/index.html"
          echo ""
          echo "=== Deployment Info ==="
          docker service ls | grep cubeos-api || true
          echo ""
          echo "Image: ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
          docker image inspect ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} --format 'Built: {{.Created}}' 2>/dev/null || true
          exit 0
        fi
        echo "  Attempt $i/45..."
        sleep 3
      done
      echo "âŒ Health check failed after 45 attempts"
      docker service logs cubeos-api_cubeos-api --tail 50 2>/dev/null || true
      exit 1
  environment:
    name: production
    url: http://nllei01mule01:6010
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
